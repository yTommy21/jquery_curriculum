<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>jQuery</title>
    <link rel="stylesheet" href="../../common/css/reset.css">
    <link rel="stylesheet" href="../../common/css/base.css">
    <link rel="stylesheet" href="./css/style.css">
  </head>
  <body>
    <div class="wrap">
      <div class="container">
        <div class="header">
          <p class="header__title">Search Books!</p>
        </div>
        <div class="search">
          <div class="search__text">
            <input type="text" id="js-search-word" class="search__text__input" placeholder="検索する">
          </div>
          <button id="js-search-button" class="search__btn">検索する</button>
        </div>
        <ul class="lists"></ul>
      </div>
    </div>
    <script src="../../common/js/jquery.js"></script>
    <script>
      // 楽天ブックスの総合検索APIを使って製作してください。
      // answerの挙動を良く見てね！
      //
      // 下記URLにAPIの仕様が載ってるいので、ブラウザで開いて参考にしてください。
      // https://webservice.rakuten.co.jp/api/bookstotalsearch/
      //
      //
      // [使うメソッド]
      // $.each(配列, function functionName() {}) 配列に対しての繰り返し処理
      // $.ajax({}) 外部ファイルやURLに対してデータをリクエストすることができます。
      // 以下は今回使う$.ajaxの基本的な形です。
      //
      // $.ajax({
      //   url: 'https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522',
      //   type: 'GET',
      //   datatype: 'json',
      //   data: {
      //     // 「区分:サービス固有パラメーター」を確認して、必要な情報をdata内に入れましょう。
      //     applicationId: '1019399324990976605', // (今回はこのIDを使用してください)
      //     booksGenreId: '001'
      //   },
      // }).done(function(data) {
      //   // この中にデータ取得後の動きを記述していきます。
      //   console.log(data);
      // });
      //
      //
      // $.ajaxによってデータが取得できたら、必要なデータ(作品名とか作者名とか)を取得します。
      // 取得できたらHTMLに<ul class='lists'></ul>を用意しているので、その中に下のテンプレに沿ってデータを入れ込みましょう。
      // <li class='lists__item'>
      //  <div class='lists__item__inner'>
      //    <a href='' class='lists__item__link' target='_blank'>
      //      <img src='' class='lists__item__img' alt=''>
      //      <p class='lists__item__detail'>作品名：</p>
      //      <p class='lists__item__detail'>作者　：</p>
      //      <p class='lists__item__detail'>出版社：</p>
      //    </a>
      //  </div>
      // </li>
      //
      //
      //
      $(function() {
        // 前回検索した単語
        var beforeSearchString = "";

        // 繰り返し検索回数
        var repeatCount = 0;

        // 検索ボタンが押された時の処理
        $('#js-search-button').click(function() {
          // 検索文字列の取得
          var searchString = $('#js-search-word').val();

          // 検索結果が見つからなかったメッセージの削除
          $('.message').remove();

          // 前回検索した単語かどうか
          if(searchString === beforeSearchString) {
            // 繰り返し検索回数を1回増やす
            repeatCount += 1;

          }else if(searchString !== beforeSearchString) {
            // 繰り返し検索回数を1にする
            repeatCount = 1;
            // 前回検索された単語として追加
            beforeSearchString = searchString;

            // ulタグの中身を全消去する
            $('.lists').empty();

          }
          // ajax通信
          booksDisplay(searchString, repeatCount);
        });
      });

      /**
       * 画面に検索した単語にマッチする書籍リストを表示する
       *
       * @param searchString 検索する単語
       * @param repeatCount 同じ単語の検索を実行した回数
       */
      function booksDisplay(searchString, repeatCount) {
        $.ajax({
          url: 'https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522',
          type: 'GET',
          datatype: 'json',
          data: {
            // 「区分:サービス固有パラメーター」を確認して、必要な情報をdata内に入れましょう。
            applicationId: '1019399324990976605', // (今回はこのIDを使用してください)
            booksGenreId: '001',
            hits: '20',
            page: repeatCount,
            keyword: searchString
          },
        }).done(function(data) {
          // この中にデータ取得後の動きを記述していきます。
          console.log(data);
          var dataLength = data.Items.length;

          console.log(dataLength);
          // jsonのlengthが0かどうかの分岐
          if(dataLength == 0) {
            // 検索結果がなかった場合のメッセージdivタグ
            var div = '<div class="message">検索結果が見つかりませんでした<br>別のキーワードで検索して下さい。</div>';

            // ulの一つ上にメッセージdivを追加
            $('.lists').before(div);

          }else if(dataLength > 0){
            // 画面に表示する書籍リストのDOMを格納するjqueryオブジェクト
            var booksList = "";

            // ２０冊未満しかデータがなかった場合のために、jsonLengthを指定
            for(var i = 0; i < dataLength; i++) {
              var item = data.Items[i].Item;
              var addItem = createBookDOMText(item);

              // 書籍リストのjqueryオブジェクトに作成した１冊分を追加する
              booksList += addItem;
            }
            // console.log(booksList[0]);

            // liのリストをulの要素のすぐ下に追加
            $('.lists').prepend(booksList);
          }
        }).fail(function(err) {
          var error = err.responseJSON.error;
          var errorDesc = err.responseJSON.error_description;
          var errorStatus = err.status;
          console.log(err);
          console.log(error);
          console.log(errorDesc);
          console.log(errorStatus);
          if(!error || !errorDesc || !errorStatus) {
            alert('APIとの通信に失敗しました。');
          }else {
            alert('[' + errorStatus + ': ' + error + '] ' + errorDesc);
          }

        });
      }


      /**
       * オブジェクトをテキスト形式でDOM生成用テキストを返す関数
       *
       * @param item 本１冊分のオブジェクト
       * @returns li 本１冊分のDOM生成用テキスト
       */
      function createBookDOMText(item) {
        var itemAuthor = item.author;               // 作者名
        var itemPublisherName = item.publisherName; // 出版社名
        var itemTitle = item.title;                 // 作品名
        var itemUrl = item.itemUrl;                 // 商品ページURL
        var itemImageUrl = item.largeImageUrl;      // 画像のURL

        // 大枠のliタグ
        var li = '<li class="lists__item">';

        // liの子要素のdivタグ
        li += '<div class="lists__item__inner">';

        // divタグの子要素のaタグ
        li += '<a class="lists__item__link" href="' + itemUrl + '" target="_blank">';

        // aタグの子要素
        li += '<img src="' + itemImageUrl + '" clss="lists__item__img" alt="' + itemTitle + '">';

        li += '<p class="lists__item__detail">作品名：　' + itemTitle + '</p>';

        li += '<p class="lists__item__detail">作者　：　' + itemAuthor + '</p>';

        li += '<p class="lists__item__detail">出版社：　' + itemPublisherName + '</p>';

        // 閉じタグをまとめて追加
        li += '</a></div></li>';

        // それぞれの親にappendしてreturn
        return li
      }

      /**
       * オブジェクトを受け取って指定のDOMに整形する
       *
       * @param item 本１冊分のオブジェクト
       * @returns {void | *}
       */
      function createBookDOM(item) {
        var itemAuthor = item.author;               // 作者名
        var itemPublisherName = item.publisherName; // 出版社名
        var itemTitle = item.title;                 // 作品名
        var itemUrl = item.itemUrl;                 // 商品ページURL
        var itemImageUrl = item.largeImageUrl;      // 画像のURL

        // 大枠のliタグ
        var li = $('<li></li>').addClass('lists__item');

        // liの子要素のdivタグ
        var div = $('<div></div>').addClass('lists__item__inner');

        // divタグの子要素のaタグ
        var a = $('<a>').addClass('lists__item__link').attr('href', itemUrl).attr('target', '_blank');

        var img = $('<img>').attr('src', itemImageUrl).addClass('lists__item__img').attr('alt', itemTitle);

        // aタグの子要素のpタグ3つ
        var pTitleText = '作品名：　' + itemTitle;
        var pTitle = $('<p></p>').addClass('lists__item__detail').text(pTitleText);

        var pWriterText = '作者　：　' + itemAuthor;
        var pWriter = $('<p></p>').addClass('lists__item__detail').text(pWriterText);

        var pPublisherText = '出版社：　' + itemPublisherName;
        var pPublisher = $('<p></p>').addClass('lists__item__detail').text(pPublisherText);

        // それぞれの親にappendしてreturn
        return li.append(div.append(a.append(img).append(pTitle).append(pWriter).append(pPublisher)));
      }
    </script>
  </body>
</html>
